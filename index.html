<!doctype html>
<head>
    <link rel="stylesheet" href="css/style.css">
    <meta charset="UTF-8">
    <!-- <link rel=icon href="img/favicon.png"> -->
    <!-- <link rel="apple-touch-icon-precomposed" href="img/favicon_apple.png"> -->
    <title>pew pew >[]} ---- ((o))</title>
</head>

<body onload="RESOURCES_ONLOAD()">

<img src="res/player.svg" id="player_img" hidden>
<img src="res/ennemy.svg" id="ennemy_img" hidden>
<img src="res/missile.svg" id="missile_img" hidden>
<img src="res/explosion.svg" id="explosion_img" hidden>

<!-- Load js files -->
<script type="text/javascript" src="js/helper.js"></script>
<script type="text/javascript" src="js/entities/bullet.js"></script>
<script type="text/javascript" src="js/starsystem.js"></script>
<script type="text/javascript" src="js/ennemymanager.js"></script>
<script type="text/javascript" src="js/entities/ennemy.js"></script>
<script type="text/javascript" src="js/ennemybehavior.js"></script>
<script type="text/javascript" src="js/entities/player.js"></script>
<script type="text/javascript" src="js/entities/explosion.js"></script>
<script type="text/javascript" src="js/audiomanager.js"></script>
<script type="text/javascript" src="js/physicsmanager.js"></script>
<script type="text/javascript" src="js/game.js"></script>
<script type="text/javascript" src="js/ui/tutorial.js"></script>
<script type="text/javascript" src="js/ui/lifebar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/howler@2.0.4/dist/howler.min.js"></script>

<div id="gameId">
    <!-- should be handled by game.audio (AudioManager instance)
    <audio autoplay="true" loop="true" muted="true" id="backgroundmusic">
        <source src="res/Smockpuppet_-_Spacer.ogg" type="audio/ogg">
        <source src="res/Smockpuppet_-_Spacer.mp3" type="audio/mpeg">
    </audio>
    -->

    <canvas id="gameCanvas" width ="800" height="650"></canvas>
    <script type="text/javascript">
    "use strict";

    var LOADING_RESOURCES = true;

    window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.oRequestAnimationFrame;

    var gameCanvas = document.getElementById("gameCanvas");
    function wScr() { return gameCanvas.width; }
    function hScr() { return gameCanvas.height; }
    function worldSize() { return Math.min(wScr(), hScr()); }
    var game = new Game();

    var keysPressed = new Set();
    window.addEventListener('keydown', this.keyDown, false);
    window.addEventListener('keyup', this.keyUp, false);
    function keyDown(e) {
        keysPressed.add(e.keyCode);
    }
    function keyUp(e) {
        keysPressed.delete(e.keyCode);
    }

    var kMAX_LAG = 0.1; // maximal duration sent to the simulation at each frame

    var oldTimestamp = Date.now();
    function step(timestamp) {
        var ds = (timestamp - oldTimestamp) / 1000;
        ds = Math.max(0, ds);
        ds = Math.min(ds, kMAX_LAG);

        var ctx = gameCanvas.getContext("2d");
        ctx.canvas.width  = window.innerWidth;
        ctx.canvas.height = window.innerHeight;

        ctx.save();

        ctx.translate(gameCanvas.width / 2, gameCanvas.height / 2);
        if (LOADING_RESOURCES) {
            ctx.textAlign = "center";
            ctx.fillStyle = "white";
            ctx.font = "75px Arial";
            ctx.fillText("Loading resources", 0, 0);
        } else {
            game.update(ds, keysPressed);
            game.draw(ctx);
        }

        ctx.restore();

        requestAnimationFrame(step);
        oldTimestamp = timestamp;
    }

    requestAnimationFrame(step);

    function RESOURCES_ONLOAD() {

        // backgroundmusic.muted = false;
        LOADING_RESOURCES = false;
        console.log("Resource load : OK");
    }
    </script>
</div>

</body>
